<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Astronaut Animation</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #0b0c10;
      color: white;
      font-family: system-ui, sans-serif;
    }
    model-viewer {
      width: 100%;
      height: 100vh;
      display: block;
    }
    #overlay {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      font-size: 18px;
      cursor: pointer;
      z-index: 10;
      flex-direction: column;
      text-align: center;
    }
    #overlay p {
      font-size: 14px;
      color: #ccc;
      margin-top: 6px;
    }
    button[slot="ar-button"] {
      display: none;
    }
  </style>
</head>
<body>

<model-viewer id="mv"
  src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
  ios-src="https://modelviewer.dev/shared-assets/models/Astronaut.usdz"
  alt="Astronaut Waving"
  ar
  ar-modes="quick-look scene-viewer webxr"
  ar-scale="auto"
  camera-controls
  shadow-intensity="1"
  animation-name="Wave"
  autoplay
  loop
>
  <a slot="ar" rel="ar" href="https://modelviewer.dev/shared-assets/models/Astronaut.usdz">
    <img src="https://modelviewer.dev/assets/ShopifyModels/Astronaut.webp" width="1" height="1" alt="Astronaut Preview">
  </a>
</model-viewer>

<div id="overlay">
  <div>Tap anywhere to enter AR</div>
  <p>iPhone: Safari only | Android: Chrome</p>
</div>

<script>
  (async function() {
    const mv = document.getElementById('mv');
    const overlay = document.getElementById('overlay');
    const arLink = mv.querySelector('a[rel="ar"]');

    const isIOS = () => /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isAndroid = () => /Android/i.test(navigator.userAgent);

    // Play animation in a loop
    async function playAnimationLoop() {
      await mv.updateComplete;
      const anims = mv.availableAnimations || [];
      if (anims.length > 0) {
        const chosen = anims.includes("Wave") ? "Wave" : anims[0];
        mv.animationName = chosen;
        mv.timeScale = 1;
        mv.loop = true;
        mv.play();
        console.log("[AR] Auto-looping animation:", chosen);
      }
    }

    // AR session start
    mv.addEventListener("ar-status", e => {
      if (e.detail.status === "session-started") {
        setTimeout(playAnimationLoop, 200);
        if (navigator.vibrate) navigator.vibrate(20);
      } else if (e.detail.status === "not-presenting" || e.detail.status === "failed") {
        try { mv.pause(); mv.currentTime = 0; } catch (e) {}
      }
    });

    // Pause initially
    mv.addEventListener("load", () => { mv.pause(); mv.animationName = null; });

    // Trigger AR on user tap
    function triggerAR() {
      overlay.remove();
      if (mv.canActivateAR) { mv.activateAR().catch(() => console.log("[AR] activateAR failed")); return; }
      if (isIOS() && arLink && arLink.href) { arLink.click(); return; }
      if (isAndroid() && mv.src) { window.location.href = mv.src; return; }
    }

    overlay.addEventListener("click", triggerAR, { once: true });
    document.addEventListener("touchstart", triggerAR, { once: true });
  })();
</script>

</body>
</html>
