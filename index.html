<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Robot AR — Quick Look + Auto Play</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    html,body { height:100%; margin:0; background:#0b0c10; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto; }
    model-viewer { width:100%; height:100vh; --poster-color:#0b0c10; display:block; }
    button[slot="ar-button"] {
      position: absolute; left:50%; bottom:22px; transform:translateX(-50%);
      padding:10px 16px; border-radius:999px; background:#2563eb; color:#fff; font-weight:600; border:none;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    .hint { position:fixed; left:12px; bottom:22px; color:#9aa1a9; font-size:13px; }
  </style>
</head>
<body>

<!--
  LƯU Ý:
  - Mở trang này bằng Safari (không phải Chrome / in-app).
  - Host file .usdz với MIME type: model/vnd.usdz+zip (Quick Look cần header này).
  - Demo dưới dùng RobotExpressive từ modelviewer.dev (đã sẵn .glb + .usdz).
-->

<model-viewer id="mv"
  src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb"
  ios-src="https://modelviewer.dev/shared-assets/models/RobotExpressive.usdz"
  alt="RobotExpressive"
  ar
  ar-modes="quick-look scene-viewer webxr"
  ar-scale="auto"
  camera-controls
  exposure="1"
  shadow-intensity="1"
  style="background:transparent;"
>
  <!-- Anchor bắt buộc cho iOS Quick Look: phải có <img> là con đầu tiên -->
  <a slot="ar" rel="ar" href="https://modelviewer.dev/shared-assets/models/RobotExpressive.usdz#allowsContentScaling=0">
    <img alt="robot preview" src="https://modelviewer.dev/assets/ShopifyModels/RobotExpressive.webp" style="width:1px;height:1px;object-fit:cover;">
  </a>

  <!-- Nút AR mặc định -->
  <button slot="ar-button">View in your space</button>
</model-viewer>

<div class="hint">Mở bằng Safari trên iPhone → bấm "View in your space" để vào AR và play animation.</div>

<script>
(function(){
  const mv = document.getElementById('mv');

  // helper log trên console
  function log(...args){ console.log('[AR]', ...args); }

  // chọn animation ưu tiên khi vào AR
  async function startPreferredAnimation() {
    try {
      // availableAnimations có thể chưa sẵn ngay lập tức: thử nhiều lần ngắn
      for (let attempt=0; attempt<10; attempt++) {
        const anims = mv.availableAnimations || [];
        if (anims.length > 0) {
          log('Available animations:', anims);
          // ưu tiên 'Dance' > 'Wave' > first
          const prefer = ['Dance','Wave','Running','Walking'];
          let chosen = anims.find(a => prefer.includes(a)) || anims[0];
          mv.animationName = chosen;
          mv.timeScale = 1;
          // đảm bảo đang play
          mv.play();
          log('Play animation:', chosen);
          return;
        }
        await new Promise(r => setTimeout(r, 150));
      }
      log('No animations detected after retries.');
    } catch (e) {
      log('Error play anim:', e);
    }
  }

  // Khi AR session bắt đầu: kích hoạt animation
  mv.addEventListener('ar-status', (e) => {
    const status = e.detail && e.detail.status;
    log('ar-status', status);
    if (status === 'session-started') {
      // delay nhỏ để Quick Look đã khởi tạo model
      setTimeout(() => startPreferredAnimation(), 120);
      // vibration (nếu có)
      if (navigator.vibrate) navigator.vibrate(30);
    }
    if (status === 'not-presenting' || status === 'failed') {
      // dừng nếu session kết thúc
      try { mv.pause(); mv.currentTime = 0; } catch(e){/*ignore*/ }
    }
  });

  // Khi model load xong trên web view, tắt auto animation (chỉ chơi trong AR)
  mv.addEventListener('load', () => {
    log('model loaded on page');
    // ngăn playback trên trang web (chỉ muốn play khi vào AR)
    try { mv.pause(); mv.animationName = null; } catch(e){/*ignore*/ }
  });

  // Thêm 1 lần kiểm tra nhanh khi user click nút AR (fallback)
  const arButton = mv.querySelector('[slot="ar-button"]');
  if (arButton) {
    arButton.addEventListener('click', () => log('AR button clicked - opening Quick Look / Scene Viewer / WebXR'));
  }

  // Debug nhỏ: show available animations vào console khi sẵn sàng
  mv.addEventListener('progress', (e) => {
    if (e.detail && e.detail.totalProgress === 1) {
      setTimeout(()=> log('Final availableAnimations:', mv.availableAnimations), 200);
    }
  });

})();
</script>
</body>
</html>
