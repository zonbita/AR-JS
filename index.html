<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Anim + Multi Sound (Auto Start)</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, sans-serif; background:#0b0c10; color:#eee; }
    model-viewer { width: 100%; height: 100vh; --poster-color: #0b0c10; }
    .controls { position: absolute; left: 50%; bottom: 18px; transform: translateX(-50%); z-index: 3; display:flex; gap:8px; }
    .controls button { padding: 10px 14px; border-radius: 999px; border: none; background: #2563eb; color: #fff; font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,.25); }
    .diag { position: fixed; right: 10px; bottom: 10px; font-size: 12px; color:#cbd5e1; opacity:.95; max-width: 46vw; background: rgba(0,0,0,0.45); padding:8px 10px; border-radius:8px; }
  </style>
</head>
<body>
  <model-viewer
    id="viewer"
    src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
    ios-src="https://modelviewer.dev/shared-assets/models/Astronaut.usdz"
    alt="Astronaut"
    ar
    ar-modes="webxr scene-viewer quick-look"
    ar-placement="floor"
    ar-scale="fixed"
    camera-controls
    tone-mapping="aces"
    shadow-intensity="1"
    autoplay
    animation-loop
  >
    <a id="platformArLink" slot="ar" rel="ar" style="display:none"></a>
    <button slot="ar-button" id="arButton">View in your space</button>
  </model-viewer>

  <!-- Reusable audio element -->
  <audio id="modelSound" preload="auto"></audio>

  <div class="controls">
    <button id="btnAR" type="button">View in your space</button>
  </div>
  <div class="diag" id="diag">Loading…</div>

  <script>
  (async function init() {
    const mv = document.getElementById("viewer");
    const sound = document.getElementById("modelSound");
    const diag = document.getElementById("diag");

    // Map animation names → audio files
    const animSounds = {
      "Idle": "https://cdn.pixabay.com/download/audio/2021/10/20/audio_888d2.mp3?filename=ambient-space-11077.mp3",
      "Walk": "https://cdn.pixabay.com/download/audio/2022/03/15/audio_35f9e.mp3?filename=footsteps-snow-11098.mp3",
      "Wave": "https://cdn.pixabay.com/download/audio/2022/03/09/audio_9d1a9.mp3?filename=whoosh-11020.mp3",
      "*":   "https://cdn.pixabay.com/download/audio/2022/03/15/audio_5f2f9d.mp3?filename=space-ambient-110624.mp3" // fallback
    };

    function log(msg) {
      console.log("[AR Debug]", msg);
      diag.textContent = msg;
    }

    function playSoundFor(anim) {
      const src = animSounds[anim] || animSounds["*"];
      if (sound.src !== src) {
        sound.pause();
        sound.src = src;
        sound.currentTime = 0;
      }
      sound.loop = true;
      sound.play().catch(err => log("Autoplay blocked until gesture: " + err));
    }

    // When model finishes loading → start animation + sound
    mv.addEventListener("load", () => {
      const allAnims = mv.availableAnimations || [];
      const firstAnim = allAnims.length ? allAnims[0] : "*";

      log("Model loaded. Starting animation: " + firstAnim);

      mv.animationName = firstAnim;
      mv.play({ repetitions: Infinity });

      playSoundFor(firstAnim);
    });

    // Listen for animation changes
    mv.addEventListener("animation-change", (e) => {
      const anim = e.detail.name || "*";
      log("Animation changed: " + anim);
      playSoundFor(anim);
    });

    // Stop sound when AR ends
    mv.addEventListener("ar-status", (e) => {
      if (e.detail.status === "not-presenting") {
        sound.pause();
      }
    });

    log("Ready. Model will auto-play animation + sound when loaded.");
  })();
  </script>
</body>
</html>
