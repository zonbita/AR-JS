<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tap-to-Place AR (iPhone + Android) — Play Anim</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <link rel="preload" as="fetch" href="https://modelviewer.dev/shared-assets/models/RobotExpressive.usdz" type="model/vnd.usdz+zip" crossorigin>
  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, sans-serif; background:#0b0c10; color:#eee; }
    model-viewer { width: 100%; height: 100vh; --poster-color: #0b0c10; }
    .controls { position: absolute; left: 50%; bottom: 18px; transform: translateX(-50%); z-index: 3; display:flex; gap:8px; }
    .controls button { padding: 10px 14px; border-radius: 999px; border: none; background: #2563eb; color: #fff; font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,.25); }
    .diag { position: fixed; right: 10px; bottom: 10px; font-size: 12px; color:#cbd5e1; opacity:.95; max-width: 46vw; background: rgba(0,0,0,0.45); padding:8px 10px; border-radius:8px; }
  </style>
</head>
<body>
  <model-viewer
    id="viewer"
    src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb"
    ios-src="https://modelviewer.dev/shared-assets/models/RobotExpressive.usdz"
    alt="Robot"
    ar
    ar-modes="webxr scene-viewer quick-look"
    ar-placement="floor"
    ar-scale="fixed"
    camera-controls
    autoplay
    shadow-intensity="1"
  >
    <a id="platformArLink" slot="ar" rel="ar" style="display:none"></a>
    <button slot="ar-button" id="arButton">View in your space</button>
  </model-viewer>

  <div class="controls">
    <button id="btnAR" type="button">View in your space</button>
  </div>
  <div class="diag" id="diag">Init…</div>

  <script>
  (async function(){
    const mv = document.getElementById('viewer');
    const btnAR = document.getElementById('btnAR');
    const diag = document.getElementById('diag');

    function log(msg){ console.log('[AR]', msg); diag.textContent = msg; }

    // Chọn animation ưa thích
    async function playAnimation() {
      await mv.updateComplete;
      const anims = mv.availableAnimations || [];
      if (anims.length > 0) {
        const prefer = ["Dance","Wave","Running","Walking"];
        const chosen = anims.find(a => prefer.includes(a)) || anims[0];
        mv.animationName = chosen;
        mv.timeScale = 1;
        mv.play();
        log("Playing animation: " + chosen);
      } else {
        log("No animations found.");
      }
    }

    // Khi AR bắt đầu → play anim
    mv.addEventListener("ar-status", e => {
      log("ar-status: " + e.detail.status);
      if (e.detail.status === "session-started") {
        setTimeout(playAnimation, 300);
      }
    });

    // Khi model load trên web → không auto play (chỉ play khi vào AR)
    mv.addEventListener("load", () => {
      mv.pause();
      mv.animationName = null;
    });

    btnAR.addEventListener("click", async e => {
      e.preventDefault();
      if (mv.canActivateAR) {
        await mv.activateAR();
      } else {
        log("Cannot activate AR in this browser.");
      }
    });

  })();
  </script>
</body>
</html>
