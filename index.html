<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tap-to-Place AR (iPhone + Android) — RobotExpressive</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <!-- Preload the USDZ to avoid 404 -->
  <link rel="preload" as="fetch" href="https://raw.githubusercontent.com/google/model-viewer/master/packages/shared-assets/models/RobotExpressive.usdz" type="model/vnd.usdz+zip" crossorigin>
  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, sans-serif; background:#0b0c10; color:#eee; }
    model-viewer { width: 100%; height: 100vh; --poster-color: #0b0c10; }
    .controls { position: absolute; left: 50%; bottom: 18px; transform: translateX(-50%); z-index: 3; display:flex; gap:8px; }
    .controls button, .controls a { padding: 10px 14px; border-radius: 999px; border: none; background: #2563eb; color: #fff; font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,.25); text-decoration:none; }
    .controls .secondary { background: rgba(255,255,255,.06); color:#e6edf3; box-shadow:none; border:1px solid rgba(255,255,255,.06); }
    .diag { position: fixed; right: 10px; bottom: 10px; font-size: 12px; color:#cbd5e1; opacity:.95; max-width: 46vw; background: rgba(0,0,0,0.45); padding:8px 10px; border-radius:8px; }
    .notes { position: fixed; left: 10px; bottom: 10px; font-size: 12px; color:#9aa1a9; max-width: 46vw; }
  </style>
</head>
<body>
  <model-viewer
    id="viewer"
    src="https://raw.githubusercontent.com/google/model-viewer/master/packages/shared-assets/models/RobotExpressive.glb"
    ios-src="https://raw.githubusercontent.com/google/model-viewer/master/packages/shared-assets/models/RobotExpressive.usdz"
    alt="Animated Robot"
    ar
    ar-modes="webxr scene-viewer quick-look"
    ar-placement="floor"
    ar-scale="fixed"
    camera-controls
    autoplay
    animation-loop
    tone-mapping="aces"
    shadow-intensity="1"
    interaction-prompt="auto"
  >
    <a id="platformArLink" slot="ar" rel="ar" style="display:none"></a>
    <button slot="ar-button" id="arButton">View in your space</button>
  </model-viewer>

  <div class="controls" role="region" aria-label="AR controls">
    <button id="btnAR" type="button">View in your space</button>
    <button id="btnDiag" class="secondary" type="button">Run diagnostics</button>
    <a id="manualScene" class="secondary" href="#">Open Scene Viewer</a>
  </div>

  <div class="diag" id="diag">Initializing…</div>
  <div class="notes">Notes: This page now loads <code>RobotExpressive.glb</code> which has multiple animations. Autoplay is enabled.</div>

  <script>
  (async function init() {
    const mv = document.getElementById('viewer');
    const btnAR = document.getElementById('btnAR');
    const btnDiag = document.getElementById('btnDiag');
    const manualScene = document.getElementById('manualScene');
    const platformArLink = document.getElementById('platformArLink');
    const diag = document.getElementById('diag');

    const isAndroid = () => /Android/i.test(navigator.userAgent);
    const isIOS = () => /iPhone|iPad|iPod/i.test(navigator.userAgent);

    function log(...parts) {
      const text = parts.map(p => (typeof p === 'object' ? JSON.stringify(p) : String(p))).join(' ');
      console.log('[AR Debug]', text);
      diag.textContent = text;
    }

    await customElements.whenDefined('model-viewer');
    log('model-viewer defined');

    const glb = mv.getAttribute('src');
    const usdz = mv.getAttribute('ios-src');

    if (platformArLink && usdz) {
      try {
        platformArLink.href = new URL(usdz, location.href).href + '#allowsContentScaling=0';
      } catch (e) {}
    }

    // Animations: cycle through them every 5s
    mv.addEventListener("load", () => {
      if (mv.availableAnimations.length > 0) {
        let current = 0;
        mv.animationName = mv.availableAnimations[current];
        log("Playing animation: " + mv.animationName);

        setInterval(() => {
          current = (current + 1) % mv.availableAnimations.length;
          mv.animationName = mv.availableAnimations[current];
          log("Switched to animation: " + mv.animationName);
        }, 5000);
      }
    });

    // Diagnostics runner
    async function runDiagnostics() {
      log('UserAgent: ' + navigator.userAgent);
      log('GLB: ' + glb);
      log('USDZ: ' + usdz);
      log('Diagnostics complete. Try pressing "View in your space".');
    }

    btnDiag.addEventListener('click', runDiagnostics);

    manualScene.href = glb || '#';

    btnAR.addEventListener('click', async (ev) => {
      ev.preventDefault();
      log('AR button clicked — checking capabilities...');
      if (mv.canActivateAR) {
        await mv.activateAR();
        return;
      }
      if (isIOS() && platformArLink && platformArLink.href) {
        platformArLink.click();
        return;
      }
      if (isAndroid() && glb) {
        window.open(`https://arvr.google.com/scene-viewer/1.0?file=${encodeURIComponent(glb)}&mode=ar_preferred`, '_self');
        return;
      }
      log('AR not available on this device.');
    });

    mv.addEventListener('ar-status', (e) => {
      const { status } = e.detail || {};
      log('ar-status: ' + status);
    });

    await runDiagnostics();
  })();
  </script>
</body>
</html>
