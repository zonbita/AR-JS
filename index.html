<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Always Follow Camera</title>
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"
    ></script>
    <style>
      body {
        margin: 0;
        background: #000;
      }
      model-viewer {
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <model-viewer
      id="mv"
      src="https://modelviewer.dev/shared-assets/models/Astronaut.glb"
      ar
      ar-modes="webxr scene-viewer quick-look"
      camera-controls
      auto-rotate
      exposure="1"
      shadow-intensity="1"
      alt="AR Follow Camera"
    ></model-viewer>

    <script type="module">
      const mv = document.getElementById("mv");

      // Khi v√†o AR
      mv.addEventListener("ar-status", (e) => {
        if (e.detail.status === "session-started") {
          console.log("üü¢ AR started ‚Äî follow camera activated");

          // L·∫•y WebXR session
          const session = mv.xrSession;
          const viewerRefSpace = mv.xrReferenceSpace;

          if (session && viewerRefSpace) {
            const onXRFrame = (time, frame) => {
              const pose = frame.getViewerPose(viewerRefSpace);
              if (pose) {
                // V·ªã tr√≠ camera
                const camPos = pose.transform.position;
                const camOrient = pose.transform.orientation;

                // ƒê·∫∑t model tr∆∞·ªõc m·∫∑t camera 1 m√©t
                const distance = 1.0;
                const dir = new THREE.Vector3(0, 0, -distance);
                const quat = new THREE.Quaternion(
                  camOrient.x,
                  camOrient.y,
                  camOrient.z,
                  camOrient.w
                );
                dir.applyQuaternion(quat);
                const targetPos = {
                  x: camPos.x + dir.x,
                  y: camPos.y + dir.y,
                  z: camPos.z + dir.z,
                };

                mv.position = `${targetPos.x} ${targetPos.y} ${targetPos.z}`;
              }

              session.requestAnimationFrame(onXRFrame);
            };

            session.requestAnimationFrame(onXRFrame);
          }
        }
      });
    </script>
  </body>
</html>
