<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <meta name="theme-color" content="#0b0c10" />
  <title>Robot AR + WebXR (Stable)</title>

  <!-- Favicon (fix 404) -->
  <link rel="icon" type="image/png" href="https://modelviewer.dev/favicon.png" />

  <!-- model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; margin: 0; background: #0b0c10; color: #fff; font-family: system-ui, sans-serif; }
    .wrap { position: relative; height: 100vh; }
    model-viewer {
      width: 100%; height: 100%; display: block; background: #0b0c10;
      --poster-color: #0b0c10;
    }
    /* N√∫t AR t√πy bi·∫øn */
    button[slot="ar-button"]{
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      padding: 12px 20px; font-size: 16px; font-weight: 600;
      border-radius: 12px; border: none; cursor: pointer;
      background: #ffe66d; color: #1b1e23; box-shadow: 0 6px 20px rgba(255, 230, 109, .35);
    }
    button[slot="ar-button"]:active { transform: translateX(-50%) scale(.98); }
    /* Badge th√¥ng b√°o */
    .notice {
      position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.15);
      padding: 8px 12px; border-radius: 10px; backdrop-filter: blur(8px);
      font-size: 13px; line-height: 1.2;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="notice" class="notice hidden">üîé ƒêang ki·ªÉm tra h·ªó tr·ª£ AR‚Ä¶</div>

    <model-viewer id="mv"
      src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb"
      ios-src="https://raw.githubusercontent.com/zonbita/AR-JS/main/dance.usdz"
      alt="Robot Expressive"
      ar
      ar-modes="webxr scene-viewer quick-look"
      ar-scale="fixed"              <!-- tr√°nh scale b·∫•t ng·ªù khi v√†o AR -->
      camera-controls
      exposure="1"
      shadow-intensity="1"
      shadow-softness="0.6"
      poster="https://modelviewer.dev/assets/poster-droid.png"
      autoplay
      tone-mapping="aces"
      disable-zoom
    >
      <!-- N√∫t m·ªü AR -->
      <button slot="ar-button" id="arBtn">üöÄ Xem trong AR</button>
    </model-viewer>
  </div>

  <!-- √Çm thanh cho WebXR (ch·ªâ ph√°t khi ·ªü trong phi√™n WebXR) -->
  <audio id="bgm" src="https://raw.githubusercontent.com/zonbita/AR-JS/main/lactroi.mp3" preload="auto" loop></audio>

  <script>
    const mv = document.getElementById('mv');
    const bgm = document.getElementById('bgm');
    const notice = document.getElementById('notice');

    // --------- Helpers
    const isSecure = () => location.protocol === 'https:' || location.hostname === 'localhost';
    const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    function show(msg, ms=2200){
      notice.textContent = msg;
      notice.classList.remove('hidden');
      clearTimeout(show._t);
      show._t = setTimeout(()=> notice.classList.add('hidden'), ms);
    }

    // --------- Ki·ªÉm tra m√¥i tr∆∞·ªùng
    if (!isSecure()) {
      show('‚ö†Ô∏è H√£y ch·∫°y tr√™n HTTPS (ho·∫∑c localhost) ƒë·ªÉ b·∫≠t AR.');
    } else {
      // Model-Viewer s·∫Ω t·ª± quy·∫øt AR mode d·ª±a tr√™n thi·∫øt b·ªã
      // Ta ch·ªâ hi·ªán m·ªôt th√¥ng b√°o ng·∫Øn g·ªçn cho UX
      show('‚úÖ Thi·∫øt b·ªã s·∫µn s√†ng. Nh·∫•n ‚ÄúXem trong AR‚Äù.', 1800);
    }

    // --------- ƒêi·ªÅu khi·ªÉn animation m·∫∑c ƒë·ªãnh trong ch·∫ø ƒë·ªô 3D
    mv.addEventListener('load', () => {
      const anims = mv.availableAnimations || [];
      if (anims.length) {
        mv.animationName = anims.includes('Dance') ? 'Dance' : anims[0];
        mv.loop = true;
        mv.timeScale = 1;
        if (mv.play) mv.play();
      }
    });

    // --------- S·ª± ki·ªán AR (WebXR trong tr√¨nh duy·ªát)
    // L∆∞u √Ω: Khi v√†o Scene Viewer (Android) ho·∫∑c Quick Look (iOS), trang b·ªã t·∫°m d·ª´ng => nh·∫°c web kh√¥ng ph√°t ƒë∆∞·ª£c.
    mv.addEventListener('ar-status', (e) => {
      const s = e.detail.status;
      if (s === 'session-started') {
        // WebXR session trong tr√¨nh duy·ªát
        if (navigator.vibrate) navigator.vibrate(15);

        // ƒë·∫£m b·∫£o animation ch·∫°y
        try { if (mv.play) mv.play(); } catch {}

        // Ph√°t nh·∫°c (user ƒë√£ t∆∞∆°ng t√°c ‚Üí kh√¥ng b·ªã ch·∫∑n)
        bgm.currentTime = 0;
        bgm.volume = 1;
        bgm.play().catch(()=> console.log('[WebXR] play() b·ªã ch·∫∑n.'));
      }
      if (s === 'not-presenting' || s === 'failed') {
        // Tho√°t WebXR ho·∫∑c l·ªói
        try { bgm.pause(); bgm.currentTime = 0; } catch {}
      }
    });

    // --------- B·∫Øt s·ª± ki·ªán click n√∫t AR ƒë·ªÉ ƒë·∫£m b·∫£o audio ƒë∆∞·ª£c "unlock" b·ªüi user gesture
    document.getElementById('arBtn').addEventListener('click', () => {
      // Ch·ªâ "n·∫°p" audio; n·∫øu sau ƒë√≥ v√†o Scene Viewer/Quick Look th√¨ trang s·∫Ω b·ªã t·∫°m d·ª´ng.
      bgm.play().then(() => { bgm.pause(); bgm.currentTime = 0; }).catch(()=>{});
      if (isIOS()) {
        show('üì≤ iOS s·∫Ω m·ªü Quick Look (audio web kh√¥ng ph√°t trong AR).', 2500);
      }
    });

    // --------- Ph√≤ng khi n√∫t AR b·ªã ·∫©n v√¨ device kh√¥ng h·ªó tr·ª£
    mv.addEventListener('ar-button', (e) => {
      // model-viewer 1.x ph√°t s·ª± ki·ªán n√†y khi render n√∫t; kh√¥ng c·∫ßn x·ª≠ l√Ω g√¨ th√™m
    });

    // --------- Optional: log ch·∫©n ƒëo√°n
    mv.addEventListener('error', (e) => {
      console.warn('[model-viewer] error:', e?.detail || e);
      show('‚ö†Ô∏è C√≥ l·ªói model-viewer. Ki·ªÉm tra console.', 3000);
    });
  </script>
</body>
</html>
