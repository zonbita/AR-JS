<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>3D UI Autoplay Animation</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
      html, body {
        margin: 0;
        overflow: hidden;
        background: #000;
        height: 100%;
      }

      /* Nền camera */
      video#camera {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        z-index: 0;
      }

      /* Model 3D */
      model-viewer {
        position: fixed;
        top: 50%;
        left: 50%;
        width: 100%;
        height: 100%;
        transform: translate(-50%, -50%);
        background: transparent;
        z-index: 1;
      }

      /* Hiệu ứng mờ dần khi model và âm thanh sẵn sàng */
      #fadeCover {
        position: fixed;
        inset: 0;
        background: #000;
        z-index: 2;
        opacity: 1;
        transition: opacity 1.5s ease;
      }
      #fadeCover.hidden {
        opacity: 0;
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <!-- Camera nền -->
    <video id="camera" autoplay muted playsinline></video>

    <!-- Model 3D -->
    <model-viewer
      id="obj"
      src="embe5.glb"
      ios-src="embe5.usdz"
      camera-controls
      auto-rotate
      autoplay
      interaction-prompt="none"
      shadow-intensity="1"
      exposure="1"
      touch-action="pan-y"
    ></model-viewer>

    <!-- Âm thanh nền (tự động, muted rồi unmute sau) -->
    <audio id="bgm" src="voice_embe5.MP3" preload="auto" loop muted></audio>

    <!-- Hiệu ứng fade đen -->
    <div id="fadeCover"></div>

    <script>
      const cameraVideo = document.getElementById("camera");
      const mv = document.getElementById("obj");
      const bgm = document.getElementById("bgm");
      const fadeCover = document.getElementById("fadeCover");

      // Mở camera thật (background)
      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "environment" } })
        .then((stream) => (cameraVideo.srcObject = stream))
        .catch((err) => console.error("Lỗi camera:", err));

      // Khi model load → phát animation
      mv.addEventListener("load", () => {
        if (mv.availableAnimations?.length > 0) {
          mv.play({ animationName: mv.availableAnimations[0] });
        }
                // Handle background music for iOS
        if (isIOS && bgm.paused) {
          bgm.currentTime = 0;
          bgm
            .play()
            .catch((err) => console.log("Không phát được nhạc trên iOS:", err));
        }
        
      });

      // Phát nhạc autoplay (Android/PC chắc chắn OK, iOS có thể bị muted ban đầu)
      bgm.play()
        .then(() => {
          console.log("Autoplay OK (muted)");
          // Sau 0.5s thử bật tiếng
          setTimeout(() => {
            bgm.muted = false;
            bgm.volume = 1.0;
            console.log("Đã bật tiếng (nếu iOS cho phép)");
            fadeCover.classList.add("hidden");
          }, 500);
        })
        .catch((err) => {
          console.log("Autoplay bị chặn:", err);
          fadeCover.classList.add("hidden");
        });

      // Trong một số trường hợp iOS resume audio context sau tab switch
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          bgm.muted = false;
          bgm.play().catch(() => {});
        }
      });
    </script>
  </body>
</html>

