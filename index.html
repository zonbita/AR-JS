<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>3D UI Autoplay Animation</title>
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"
    ></script>
    <style>
      html,
      body {
        margin: 0;
        overflow: hidden;
        background: #000;
        height: 100%;
      }

      video#camera {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        z-index: 0;
      }

      model-viewer {
        position: fixed;
        top: 50%;
        left: 50%;
        width: 100%;
        height: 100%;
        transform: translate(-50%, -50%);
        background: transparent;
        z-index: 1;
      }

      #fadeCover {
        position: fixed;
        inset: 0;
        background: #000;
        z-index: 2;
        opacity: 1;
        transition: opacity 1.5s ease;
      }
      #fadeCover.hidden {
        opacity: 0;
        pointer-events: none;
      }

      /* Overlay yêu cầu click cho iOS */
      #iosTap {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-family: sans-serif;
        z-index: 3;
        transition: opacity 0.6s ease;
      }
      #iosTap.hidden {
        opacity: 0;
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <video id="camera" autoplay muted playsinline></video>

    <model-viewer
      id="obj"
      src="embe5.glb"
      ios-src="embe5.usdz"
      camera-controls
      auto-rotate
      autoplay
      interaction-prompt="none"
      shadow-intensity="1"
      exposure="1"
      touch-action="pan-y"
    ></model-viewer>

    <audio id="bgm" src="voice_embe5.MP3" preload="auto" loop muted></audio>

    <div id="fadeCover"></div>

    <!-- Overlay click cho iOS -->
    <div id="iosTap">👆 Nhấn để bắt đầu</div>

    <script>
      const cameraVideo = document.getElementById("camera");
      const mv = document.getElementById("obj");
      const bgm = document.getElementById("bgm");
      const fadeCover = document.getElementById("fadeCover");
      const iosTap = document.getElementById("iosTap");

      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      // Bật camera
      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "environment" } })
        .then((stream) => (cameraVideo.srcObject = stream))
        .catch((err) => console.error("Lỗi camera:", err));

      mv.addEventListener("load", () => {
        if (mv.availableAnimations?.length > 0) {
          mv.play({ animationName: mv.availableAnimations[0] });
        }

        if (!isIOS) {
          // Android/PC: phát nhạc luôn
          bgm.play()
            .then(() => {
              setTimeout(() => {
                bgm.muted = false;
                bgm.volume = 1.0;
                fadeCover.classList.add("hidden");
              }, 500);
            })
            .catch(() => fadeCover.classList.add("hidden"));
        } else {
          // iOS: yêu cầu người dùng chạm
          fadeCover.classList.add("hidden");
          iosTap.classList.remove("hidden");
        }
      });

      // Khi người dùng chạm vào iOS overlay
      iosTap.addEventListener("click", () => {
        bgm.muted = false;
        bgm.volume = 1.0;
        bgm
          .play()
          .then(() => {
            console.log("iOS: phát nhạc thành công");
            iosTap.classList.add("hidden");
          })
          .catch((err) => {
            console.warn("Không thể phát nhạc:", err);
          });
      });

      // Resume audio khi trở lại tab
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          bgm.muted = false;
          bgm.play().catch(() => {});
        }
      });
    </script>
  </body>
</html>
