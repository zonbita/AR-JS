<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tap anywhere → AR (iPhone Quick Look) — Robot Auto Play</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#0b0c10;color:#fff;font-family:system-ui,-apple-system;overflow:hidden}
    model-viewer{width:100%;height:100vh;display:block;--poster-color:#0b0c10}
    /* instruction overlay */
    .tap-overlay{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(180deg, rgba(11,12,16,0.55), rgba(11,12,16,0.45));
      z-index:20;backdrop-filter: blur(4px);
      cursor:pointer;user-select:none;
    }
    .card{padding:18px 22px;border-radius:12px;background:rgba(255,255,255,0.04);text-align:center}
    .card h1{margin:0 0 6px;font-size:18px;letter-spacing:0.2px}
    .card p{margin:0;font-size:13px;color:#b8c0cc}
    button[slot="ar-button"]{display:none} /* hide built-in button (we auto-enter) */
  </style>
</head>
<body>

<model-viewer id="mv"
  src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb"
  ios-src="https://modelviewer.dev/shared-assets/models/RobotExpressive.usdz"
  alt="RobotExpressive"
  ar
  ar-modes="quick-look scene-viewer webxr"
  ar-scale="auto"
  camera-controls
  style="background:transparent;"
>
  <!-- Anchor bắt buộc cho Quick Look: <img> phải là con đầu -->
  <a slot="ar" id="arLink" rel="ar" href="https://modelviewer.dev/shared-assets/models/RobotExpressive.usdz#allowsContentScaling=0">
    <img src="https://modelviewer.dev/assets/ShopifyModels/RobotExpressive.webp" alt="preview" style="width:1px;height:1px;object-fit:cover">
  </a>

  <!-- Giữ nhưng ẩn đi (ta auto kích) -->
  <button slot="ar-button">View in your space</button>
</model-viewer>

<!-- Overlay hướng dẫn: chạm bất kỳ đâu để vào AR -->
<div id="overlay" class="tap-overlay" role="button" aria-label="Chạm để vào AR">
  <div class="card">
    <h1>Chạm bất kỳ chỗ nào để vào AR</h1>
    <p>Mở bằng Safari trên iPhone → Quick Look sẽ bật và play animation trong AR.</p>
  </div>
</div>

<script>
(function(){
  const mv = document.getElementById('mv');
  const overlay = document.getElementById('overlay');
  const arLink = document.getElementById('arLink');
  let triggered = false;

  // Play preferred animation inside AR (Dance > Wave > first)
  async function startPreferredAnimation() {
    try {
      for (let i=0;i<12;i++){
        const anims = mv.availableAnimations || [];
        if (anims.length > 0) {
          const prefer = ['Dance','Wave','Running','Walking'];
          const chosen = anims.find(a=>prefer.includes(a)) || anims[0];
          mv.animationName = chosen;
          mv.timeScale = 1;
          mv.play();
          console.log('[AR] play animation', chosen);
          return;
        }
        await new Promise(r=>setTimeout(r,120));
      }
      console.log('[AR] no animations found');
    } catch(e){ console.warn('[AR] play error', e); }
  }

  // Khi AR session bắt đầu -> play anim
  mv.addEventListener('ar-status', (e) => {
    const status = e.detail && e.detail.status;
    console.log('[AR] status', status);
    if (status === 'session-started') {
      // Delay nhẹ để Quick Look đã load model
      setTimeout(()=> startPreferredAnimation(), 120);
      if (navigator.vibrate) navigator.vibrate(20);
    } else if (status === 'not-presenting' || status === 'failed') {
      try { mv.pause(); mv.currentTime = 0; } catch(e){}
    }
  });

  // Khi model load trên trang web, không autoplay trên web view
  mv.addEventListener('load', ()=> { try{ mv.pause(); mv.animationName = null }catch(e){} });

  // Function để trigger Quick Look — bằng cách "click" vào anchor (<a rel="ar">)
  function triggerQuickLook() {
    if (triggered) return;
    triggered = true;
    // Remove overlay quickly so click context remains
    overlay.style.opacity = '0';
    overlay.style.pointerEvents = 'none';
    setTimeout(()=> overlay.remove(), 200);

    // Try to click the anchor which is the recommended way for Quick Look
    try {
      arLink.click();
      console.log('[AR] arLink.click() called');
    } catch(e){
      // Fallback: navigate directly to .usdz (still within user gesture)
      const href = arLink && arLink.href;
      if (href) {
        window.location.href = href;
        console.log('[AR] fallback window.location ->', href);
      } else {
        console.warn('[AR] no ar href available');
      }
    }
  }

  // Accept either touchstart or click. Use capture to ensure we get first gesture.
  const handler = (ev) => {
    // ignore multi-touch gestures that might not be intentional
    if (ev.touches && ev.touches.length>1) return;
    ev.preventDefault?.();
    triggerQuickLook();
  };

  // Listen once for first user gesture on whole document
  document.addEventListener('touchstart', handler, {passive:false, once:true, capture:true});
  document.addEventListener('click', handler, {once:true, capture:true});

  // Extra: if overlay tapped directly, also trigger
  overlay.addEventListener('click', (e)=>{ e.preventDefault(); triggerQuickLook(); }, {once:true});

})();
</script>
</body>
</html>
