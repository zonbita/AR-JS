<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#0b0c10"/>
  <title>Robot AR + Sound (Play Fixed)</title>

  <!-- model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; margin: 0; background: #0b0c10; color: #fff; font-family: system-ui, -apple-system, Roboto, 'Segoe UI', Arial; }
    .wrap { position: relative; height: 100vh; overflow: hidden; }

    model-viewer {
      width: 100%; height: 100%; display: block;
      background: #0b0c10; --poster-color: #0b0c10;
    }

    /* AR button (slot="ar-button") */
    button[slot="ar-button"]{
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      padding: 12px 100px; font-size: 16px; font-weight: 600;
      border-radius: 12px; border: none; cursor: pointer;
      background: #ffe66d; color: #1b1e23; box-shadow: 0 6px 20px rgba(255,230,109,.35);
      z-index: 20;
    }
    button[slot="ar-button"]:active { transform: translateX(-50%) scale(.97); }

    /* Small control bar to explicitly Play/Pause music if autoplay blocked */
    .audio-controls {
      position: absolute; bottom: 92px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 8px; align-items: center;
      background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(6px);
      z-index: 20;
    }
    .audio-controls button { background: transparent; border: 1px solid rgba(255,255,255,0.08); color: #fff; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    .audio-controls button:active { transform: scale(.98); }

    /* Notice */
    .notice {
      position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.15);
      padding: 8px 12px; border-radius: 10px; backdrop-filter: blur(8px);
      font-size: 13px; line-height: 1.2; z-index: 20;
    }
    .hidden { display: none !important; }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="notice" class="notice hidden">üîé ƒêang ki·ªÉm tra h·ªó tr·ª£ AR‚Ä¶</div>

    <model-viewer id="mv"
      src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb"
      ios-src="https://raw.githubusercontent.com/zonbita/AR-JS/main/dance.usdz"
      alt="Robot Expressive"
      ar
      ar-modes="webxr scene-viewer quick-look"
      ar-scale="fixed"
      camera-controls
      exposure="1"
      shadow-intensity="1"
      shadow-softness="0.6"
      autoplay
      tone-mapping="aces"
      disable-zoom
      reveal="interaction"
    >
      <!-- N√∫t m·ªü AR (khi click -> model-viewer x·ª≠ l√Ω m·ªü AR) -->
      <button slot="ar-button" id="arBtn" aria-label="M·ªü AR">üöÄ Xem trong AR</button>
    </model-viewer>

    <!-- Audio controls (n√∫t play/pause r√µ r√†ng cho ng∆∞·ªùi d√πng) -->
    <div class="audio-controls" id="audioControls" aria-hidden="true">
      <button id="playBtn" type="button">‚ñ∂Ô∏è Play nh·∫°c</button>
      <button id="pauseBtn" type="button">‚è∏Ô∏è Pause</button>
      <span id="audioState" style="font-size:13px; opacity:.9;">T·∫Øt</span>
    </div>
  </div>

  <!-- NH·∫†C: ƒê·∫∑t music.mp3 c√πng th∆∞ m·ª•c v·ªõi file html, ho·∫∑c ƒë·ªïi src sang URL HTTPS -->
  <audio id="bgm" src="music.mp3" preload="auto" loop></audio>

  <script>
    (function(){
      const mv = document.getElementById('mv');
      const bgm = document.getElementById('bgm');
      const notice = document.getElementById('notice');
      const arBtn = document.getElementById('arBtn');
      const playBtn = document.getElementById('playBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const audioControls = document.getElementById('audioControls');
      const audioState = document.getElementById('audioState');

      const isSecure = () => location.protocol === 'https:' || location.hostname === 'localhost';
      const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const isAndroid = () => /Android/i.test(navigator.userAgent);

      function show(msg, ms=2200){
        notice.textContent = msg;
        notice.classList.remove('hidden');
        clearTimeout(show._t);
        show._t = setTimeout(()=> notice.classList.add('hidden'), ms);
      }

      // Ki·ªÉm tra m√¥i tr∆∞·ªùng
      if (!isSecure()) {
        show('‚ö†Ô∏è H√£y ch·∫°y tr√™n HTTPS (ho·∫∑c localhost) ƒë·ªÉ b·∫≠t AR.');
      } else {
        show('‚úÖ Thi·∫øt b·ªã s·∫µn s√†ng. Nh·∫•n ‚ÄúXem trong AR‚Äù ho·∫∑c Play nh·∫°c.', 2200);
      }

      // Hi·ªán controls ƒë·ªÉ ng∆∞·ªùi d√πng b·∫•m Play/Pause n·∫øu autoplay ch·∫∑n
      audioControls.setAttribute('aria-hidden', 'false');

      // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i text
      function setAudioState(text){
        audioState.textContent = text;
      }

      // Th·ª≠ unlock audio 1 l·∫ßn b·∫±ng 1 c·ª≠ ch·ªâ: play r·ªìi pause
      function tryUnlockAudio(){
        // M·ªôt click/tap c·ªßa ng∆∞·ªùi d√πng cho ph√©p play theo ch√≠nh s√°ch tr√¨nh duy·ªát
        return bgm.play()
          .then(()=> { bgm.pause(); bgm.currentTime = 0; setAudioState('S·∫µn s√†ng'); return true; })
          .catch(()=> { setAudioState('B·ªã ch·∫∑n'); return false; });
      }

      // N√∫t Play th·ªß c√¥ng (ng∆∞·ªùi d√πng b·∫•m => ch·∫Øc ch·∫Øn play)
      playBtn.addEventListener('click', async () => {
        try {
          await bgm.play();
          setAudioState('ƒêang ph√°t');
        } catch (err) {
          console.warn('Play failed:', err);
          // N·∫øu b·ªã ch·∫∑n, th·ª≠ unlock b·∫±ng thao t√°c kh√°c
          const ok = await tryUnlockAudio();
          if (ok) {
            try { await bgm.play(); setAudioState('ƒêang ph√°t'); } catch(e){ setAudioState('B·ªã ch·∫∑n'); }
          } else setAudioState('B·ªã ch·∫∑n');
        }
      });

      pauseBtn.addEventListener('click', () => {
        try { bgm.pause(); setAudioState('T·∫°m d·ª´ng'); } catch(e){ console.warn(e); }
      });

      // Khi b·∫•m n√∫t AR (n√∫t ·ªü slot ƒë∆∞·ª£c model-viewer d√πng ƒë·ªÉ m·ªü AR),
      // ta c≈©ng c·ªë g·∫Øng play nh·∫°c (n·∫øu tr√¨nh duy·ªát cho ph√©p).
      arBtn.addEventListener('click', async (ev) => {
        // c·ªë g·∫Øng ph√°t nh·∫°c ngay tr√™n gesture n√†y
        try {
          await bgm.play();
          setAudioState('ƒêang ph√°t');
        } catch (err) {
          // N·∫øu b·ªã ch·∫∑n, th·ª≠ unlock (play->pause) r·ªìi b√°o cho user
          console.log('[AR] audio play blocked, attempting unlock');
          await tryUnlockAudio();
          show(isIOS() ? 'üì≤ iOS Quick Look kh√¥ng cho nh·∫°c web ch·∫°y trong AR.' : 'üîä N·∫øu nh·∫°c kh√¥ng ph√°t, nh·∫•n n√∫t Play.');
        }

        // Note: model-viewer s·∫Ω x·ª≠ l√Ω m·ªü AR (khi click n√∫t trong slot).
        // Kh√¥ng c·∫ßn g·ªçi API kh√°c ·ªü ƒë√¢y.
      });

      // Khi session AR b·∫Øt ƒë·∫ßu (WebXR/Scene Viewer), ƒë·∫£m b·∫£o nh·∫°c ph√°t
      mv.addEventListener('ar-status', (e) => {
        const s = e?.detail?.status;
        if (s === 'session-started') {
          // Rung nh·∫π cho ph·∫£n h·ªìi
          if (navigator.vibrate) navigator.vibrate(20);
          // N·∫øu audio ƒë√£ unlock, ph√°t; n·∫øu ch∆∞a, th·ª≠
          bgm.currentTime = 0;
          bgm.play().then(()=> setAudioState('ƒêang ph√°t')).catch(()=> {
            console.log('[ar-status] audio blocked');
            setAudioState('B·ªã ch·∫∑n');
          });
        } else if (s === 'not-presenting' || s === 'failed') {
          try { bgm.pause(); bgm.currentTime = 0; setAudioState('T·∫Øt'); } catch(_) {}
        }
      });

      // Pause audio khi tab ·∫©n ƒë·ªÉ tr√°nh ph√°t ng·∫ßm
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          try { bgm.pause(); setAudioState('T·∫°m d·ª´ng'); } catch(_) {}
        }
      });

      // X·ª≠ l√Ω l·ªói model-viewer
      mv.addEventListener('error', (e) => {
        console.warn('[model-viewer] error:', e?.detail || e);
        show('‚ö†Ô∏è L·ªói model-viewer. M·ªü DevTools ƒë·ªÉ xem console.', 3000);
      });

      // Th·ª≠ unlock audio khi ng∆∞·ªùi d√πng c√≥ 1 l·∫ßn tap b·∫•t k·ª≥ (d√πng as a fallback)
      function oneTimeUnlockOnFirstTap() {
        const handler = async () => {
          await tryUnlockAudio();
          window.removeEventListener('pointerdown', handler, {capture:true});
        };
        window.addEventListener('pointerdown', handler, {capture:true, once:true});
      }
      oneTimeUnlockOnFirstTap();

      // Init label
      setAudioState('T·∫Øt');

      // Accessibility: if user navigates by keyboard, focus on controls
      playBtn.addEventListener('keyup', (ev) => { if (ev.key === 'Enter') playBtn.click(); });
      pauseBtn.addEventListener('keyup', (ev) => { if (ev.key === 'Enter') pauseBtn.click(); });
    })();
  </script>
</body>
</html>
