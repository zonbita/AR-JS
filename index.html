<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AR Follow Camera</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #0b0c10;
      overflow: hidden;
      color: white;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    model-viewer {
      width: 100%;
      height: 100%;
      --ar-button-display: none;
      background: #0b0c10;
    }

    /* UI 3D (hotspot) d√≠nh theo camera */
    .camera-ui {
      background: rgba(255, 215, 0, 0.9);
      border-radius: 12px;
      padding: 10px 16px;
      font-weight: bold;
      font-size: 14px;
      color: #111;
      border: 2px solid #fff;
      box-shadow: 0 0 10px rgba(255, 255, 0, 0.8);
      display: none !important;
      transform: translateZ(0);
    }

    model-viewer[ar-status="session-started"] .camera-ui {
      display: block !important;
    }

    .camera-ui:hover {
      background: rgba(255, 255, 120, 0.95);
      transform: scale(1.05);
    }

    /* Th√¥ng b√°o nh·ªè */
    .ar-info {
      position: absolute;
      top: 16px;
      left: 16px;
      right: 16px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      padding: 12px;
      font-size: 14px;
      display: none;
      z-index: 100;
    }

    .ar-info.show {
      display: block;
    }

    /* N√∫t xem AR */
    .button-group {
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 20;
    }

    .button-group button {
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      border: none;
      border-radius: 12px;
      padding: 12px 18px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .button-group button:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body>

  <div class="ar-info" id="arInfo">
    <strong>üéØ AR Mode Active!</strong>  
    <br/>Model v√† UI 3D s·∫Ω lu√¥n theo camera.
  </div>

  <model-viewer
    id="mv"
    src="1M.glb"
    ios-src="1M.usdz"
    ar
    ar-modes="webxr quick-look"
    ar-scale="auto"
    ar-placement="floor"
    alt="BABY1M"
    camera-controls
    disable-zoom
    shadow-intensity="1"
  >

    <!-- UI d√≠nh theo camera -->
    <div class="camera-ui" slot="hotspot-camera" 
      data-position="0m 0m -0.3m" 
      data-normal="0m 0m 1m"
      onclick="alert('B·∫°n v·ª´a nh·∫•n v√†o UI 3D d√≠nh camera!')">
      üéÆ B·∫Øt ƒë·∫ßu ch∆°i
    </div>
  </model-viewer>

  <div class="button-group">
    <button id="btnAR">üï∂Ô∏è B·∫≠t AR</button>
  </div>

  <script>
    const mv = document.getElementById('mv');
    const btnAR = document.getElementById('btnAR');
    const arInfo = document.getElementById('arInfo');
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

    btnAR.addEventListener('click', async () => {
      try {
        await mv.activateAR();
      } catch (e) {
        console.warn("Kh√¥ng th·ªÉ b·∫≠t AR:", e);
      }
    });

    // Khi b·∫Øt ƒë·∫ßu AR
    mv.addEventListener('ar-status', (event) => {
      const status = event.detail.status;
      if (status === 'session-started') {
        mv.setAttribute('ar-status', 'session-started');
        arInfo.classList.add('show');
        setTimeout(() => arInfo.classList.remove('show'), 4000);
        startFollowCamera();
      } else if (status === 'not-presenting') {
        mv.removeAttribute('ar-status');
      }
    });

    /**
     * Model d√≠nh theo camera:
     * C·∫≠p nh·∫≠t v·ªã tr√≠ li√™n t·ª•c d·ª±a theo pose camera trong ARSession.
     */
    function startFollowCamera() {
      const xrSession = mv.xrSession;
      if (!xrSession) return;

      const refSpace = mv.xrReferenceSpace;
      const renderLoop = (time, frame) => {
        const pose = frame.getViewerPose(refSpace);
        if (pose) {
          const pos = pose.transform.position;
          const orient = pose.transform.orientation;

          // Gi·ªØ model c√°ch camera ~0.5m v·ªÅ ph√≠a tr∆∞·ªõc
          const distance = 0.5;
          const dir = getForwardVector(orient);
          const targetX = pos.x + dir.x * distance;
          const targetY = pos.y + dir.y * distance;
          const targetZ = pos.z + dir.z * distance;

          mv.setAttribute('ar-placement', 'floor');
          mv.setAttribute('position', `${targetX} ${targetY} ${targetZ}`);
        }
        xrSession.requestAnimationFrame(renderLoop);
      };
      xrSession.requestAnimationFrame(renderLoop);
    }

    /** T√≠nh vector h∆∞·ªõng camera ƒëang nh√¨n t·ªõi */
    function getForwardVector(quat) {
      const [x, y, z, w] = [quat.x, quat.y, quat.z, quat.w];
      return {
        x: 2 * (x * z + w * y),
        y: 2 * (y * z - w * x),
        z: 1 - 2 * (x * x + y * y)
      };
    }
  </script>
</body>
</html>
