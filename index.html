<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR GLB Model Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    
    <!-- Fallback scripts cho XAMPP -->
    <script>
        // Ki·ªÉm tra n·∫øu ƒëang ch·∫°y tr√™n localhost/XAMPP
        if (location.protocol === 'http:' && location.hostname === 'localhost') {
            console.log('ƒêang ch·∫°y tr√™n XAMPP localhost');
        }
        
        // Fallback n·∫øu kh√¥ng load ƒë∆∞·ª£c AR.js
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof AFRAME === 'undefined') {
                    document.body.innerHTML = `
                        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                   background: #ff4444; color: white; padding: 20px; border-radius: 10px; 
                                   text-align: center; z-index: 9999; max-width: 80%;">
                            <h3>‚ùå L·ªói t·∫£i th∆∞ vi·ªán</h3>
                            <p>Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i</p>
                            <button onclick="location.reload()" style="background: white; color: #ff4444; 
                                   border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                                üîÑ Th·ª≠ l·∫°i
                            </button>
                        </div>
                    `;
                }
            }, 5000);
        });
    </script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: #000;
        }
        
        #arjsDebugUIContainer {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 999;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            padding: 10px;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50px;
            padding: 15px 20px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            max-width: 250px;
            z-index: 1000;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1001;
            text-align: center;
            max-width: 80%;
        }
        
        .xampp-notice {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff9800;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 1002;
            font-size: 12px;
            display: none;
        }
        
        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(255,0,0,0.8);
        }
        
        @media (max-width: 480px) {
            .controls {
                bottom: 10px;
                flex-wrap: wrap;
                max-width: 90%;
            }
            
            .control-btn {
                padding: 12px 16px;
                font-size: 12px;
                flex: 1;
                min-width: 100px;
            }
            
            .info {
                top: 60px;
                right: 10px;
                max-width: 200px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div id="xampp-notice" class="xampp-notice">
        ‚ö†Ô∏è ƒêang ch·∫°y tr√™n localhost - M·ªôt s·ªë t√≠nh nƒÉng AR c√≥ th·ªÉ b·ªã h·∫°n ch·∫ø. ƒê·ªÉ c√≥ tr·∫£i nghi·ªám t·ªët nh·∫•t, h√£y deploy l√™n HTTPS server.
        <button onclick="this.parentElement.style.display='none'" style="background: none; border: 1px solid white; color: white; margin-left: 10px; padding: 2px 8px; border-radius: 3px; cursor: pointer;">‚úï</button>
    </div>
    
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>ƒêang kh·ªüi t·∫°o AR...</div>
        <div style="font-size: 11px; margin-top: 10px; opacity: 0.8;">
            N·∫øu b·ªã k·∫πt, vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet
        </div>
    </div>
    
    <div class="info">
        <strong>üéØ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng AR:</strong><br>
        1. Cho ph√©p truy c·∫≠p camera<br>
        2. H∆∞·ªõng camera v·ªÅ marker Hiro<br>
        3. M√¥ h√¨nh 3D s·∫Ω hi·ªÉn th·ªã tr√™n marker<br>
        4. D√πng c√°c n√∫t ƒëi·ªÅu khi·ªÉn b√™n d∆∞·ªõi
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
        embedded
        gesture-detector
        id="scene">

        <a-assets timeout="10000">
            <!-- S·ª≠ d·ª•ng local models n·∫øu c√≥ th·ªÉ -->
            <a-asset-item 
                id="duck-model" 
                src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb"
                crossorigin="anonymous">
            </a-asset-item>
            
            <!-- Backup model -->
            <a-asset-item 
                id="box-model" 
                src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Box/glTF-Binary/Box.glb"
                crossorigin="anonymous">
            </a-asset-item>
            
            <!-- Local fallback - t·∫°o basic geometry n·∫øu kh√¥ng load ƒë∆∞·ª£c GLB -->
            <a-mixin id="fallback-box" 
                     geometry="primitive: box; width: 1; height: 1; depth: 1" 
                     material="color: #4CC3D9">
            </a-mixin>
        </a-assets>

        <a-marker 
            preset="hiro" 
            raycaster="objects: .clickable" 
            emitevents="true" 
            cursor="fuse: false; rayOrigin: mouse;"
            id="markerA">
            
            <!-- Main GLB model -->
            <a-gltf-model 
                id="main-model"
                src="#duck-model" 
                position="0 0 0" 
                scale="0.5 0.5 0.5"
                rotation="0 0 0"
                animation-mixer="clip: *; loop: repeat"
                class="clickable"
                gesture-handler="minScale: 0.25; maxScale: 10">
            </a-gltf-model>
            
            <!-- Lighting -->
            <a-light 
                type="ambient" 
                color="#404040" 
                intensity="0.4">
            </a-light>
            
            <a-light 
                type="directional" 
                position="0 3 1" 
                color="#ffffff" 
                intensity="0.6"
                cast-shadow="true">
            </a-light>
            
            <!-- Ground plane for shadows -->
            <a-plane 
                position="0 -0.1 0" 
                rotation="-90 0 0" 
                width="4" 
                height="4" 
                color="#7BC8A4" 
                opacity="0.3"
                receive-shadow="true">
            </a-plane>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <div class="controls">
        <button class="control-btn" onclick="rotateModel()">üîÑ Xoay</button>
        <button class="control-btn" onclick="scaleModel()">üìè Ph√≥ng to</button>
        <button class="control-btn" onclick="resetModel()">üîÑ Reset</button>
        <button class="control-btn" onclick="changeModel()">üîÑ ƒê·ªïi Model</button>
    </div>

    <script>
        let currentRotation = 0;
        let currentScale = 0.5;
        let currentModelIndex = 0;
        let isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        const models = ['#duck-model', '#box-model'];
        const modelNames = ['Duck', 'Box'];

        // Hi·ªÉn th·ªã th√¥ng b√°o XAMPP n·∫øu c·∫ßn
        if (isLocalhost && location.protocol === 'http:') {
            document.getElementById('xampp-notice').style.display = 'block';
        }

        // Hide loading when AR is ready - tƒÉng timeout cho XAMPP
        document.querySelector('a-scene').addEventListener('loaded', function () {
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, isLocalhost ? 5000 : 2000);
        });

        // X·ª≠ l√Ω l·ªói ƒë·∫∑c bi·ªát cho localhost
        window.addEventListener('error', function(e) {
            if (e.message.includes('getUserMedia') || e.message.includes('camera')) {
                showNotification('‚ö†Ô∏è L·ªói camera - C·∫ßn HTTPS ƒë·ªÉ truy c·∫≠p camera tr√™n mobile', 'error');
            }
        });

        // Error handling
        document.querySelector('a-scene').addEventListener('arjs-video-loaded', function() {
            console.log('AR Video loaded successfully');
        });

        // Model loading events v·ªõi fallback
        document.getElementById('main-model').addEventListener('model-loaded', function() {
            console.log('GLB model loaded successfully');
            showNotification('‚úÖ M√¥ h√¨nh ƒë√£ t·∫£i th√†nh c√¥ng!', 'success');
        });

        document.getElementById('main-model').addEventListener('model-error', function() {
            console.log('Error loading GLB model, trying backup...');
            // Th·ª≠ model backup tr∆∞·ªõc
            if (currentModelIndex === 0) {
                document.getElementById('main-model').setAttribute('src', '#box-model');
                showNotification('‚ö†Ô∏è ƒêang t·∫£i m√¥ h√¨nh d·ª± ph√≤ng...', 'warning');
            } else {
                // N·∫øu v·∫´n l·ªói, t·∫°o fallback geometry
                createFallbackModel();
            }
        });
        
        function createFallbackModel() {
            const model = document.getElementById('main-model');
            const parent = model.parentElement;
            
            // T·∫°o box ƒë∆°n gi·∫£n thay th·∫ø
            const fallbackBox = document.createElement('a-box');
            fallbackBox.setAttribute('id', 'fallback-model');
            fallbackBox.setAttribute('position', '0 0.5 0');
            fallbackBox.setAttribute('scale', '0.5 0.5 0.5');
            fallbackBox.setAttribute('color', '#4CC3D9');
            fallbackBox.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 10000');
            
            parent.replaceChild(fallbackBox, model);
            showNotification('üì¶ S·ª≠ d·ª•ng m√¥ h√¨nh d·ª± ph√≥ng', 'info');
        }

        // Marker detection events
        document.querySelector('#markerA').addEventListener('markerFound', function() {
            console.log('Marker detected');
            showNotification('üéØ ƒê√£ t√¨m th·∫•y marker!', 'success');
        });

        document.querySelector('#markerA').addEventListener('markerLost', function() {
            console.log('Marker lost');
            showNotification('‚ùå ƒê√£ m·∫•t marker', 'error');
        });

        // Control functions
        function rotateModel() {
            currentRotation += 45;
            const model = document.getElementById('main-model');
            model.setAttribute('rotation', `0 ${currentRotation} 0`);
            showNotification(`üîÑ Xoay ${currentRotation}¬∞`, 'info');
        }

        function scaleModel() {
            currentScale = currentScale >= 2 ? 0.25 : currentScale + 0.25;
            const model = document.getElementById('main-model');
            model.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
            showNotification(`üìè T·ª∑ l·ªá: ${currentScale}x`, 'info');
        }

        function resetModel() {
            currentRotation = 0;
            currentScale = 0.5;
            const model = document.getElementById('main-model');
            model.setAttribute('rotation', '0 0 0');
            model.setAttribute('scale', '0.5 0.5 0.5');
            model.setAttribute('position', '0 0 0');
            showNotification('üîÑ ƒê√£ reset m√¥ h√¨nh', 'success');
        }

        function changeModel() {
            currentModelIndex = (currentModelIndex + 1) % models.length;
            const model = document.getElementById('main-model');
            model.setAttribute('src', models[currentModelIndex]);
            showNotification(`üîÑ ƒê·ªïi sang: ${modelNames[currentModelIndex]}`, 'info');
            resetModel();
        }

        // Notification system
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 70px;
                left: 50%;
                transform: translateX(-50%);
                background: ${getNotificationColor(type)};
                color: white;
                padding: 10px 20px;
                border-radius: 25px;
                z-index: 1002;
                font-weight: bold;
                font-size: 14px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 3000);
        }

        function getNotificationColor(type) {
            switch(type) {
                case 'success': return 'rgba(76, 175, 80, 0.9)';
                case 'error': return 'rgba(244, 67, 54, 0.9)';
                case 'warning': return 'rgba(255, 152, 0, 0.9)';
                default: return 'rgba(33, 150, 243, 0.9)';
            }
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateX(-50%) translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
            }
            @keyframes slideOut {
                from {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(-50%) translateY(-20px);
                }
            }
        `;
        document.head.appendChild(style);

        // Touch gestures for mobile
        AFRAME.registerComponent('gesture-handler', {
            schema: {
                enabled: { default: true },
                rotationFactor: { default: 5 },
                minScale: { default: 0.3 },
                maxScale: { default: 8 },
            },

            init: function () {
                this.handleScale = this.handleScale.bind(this);
                this.handleRotation = this.handleRotation.bind(this);

                this.isVisible = false;
                this.initialScale = this.el.object3D.scale.clone();
                this.scaleFactor = 1;

                this.el.sceneEl.addEventListener('markerFound', (e) => {
                    this.isVisible = true;
                });

                this.el.sceneEl.addEventListener('markerLost', (e) => {
                    this.isVisible = false;
                });
            },

            listeners: {
                onefingermove: function (event) {
                    if (this.isVisible) {
                        this.handleRotation(event);
                    }
                },

                twofingermove: function (event) {
                    if (this.isVisible) {
                        this.handleScale(event);
                    }
                }
            },

            handleRotation: function (event) {
                if (this.data.enabled) {
                    this.el.object3D.rotation.y += event.detail.positionChange.x * this.data.rotationFactor;
                    this.el.object3D.rotation.x += event.detail.positionChange.y * this.data.rotationFactor;
                }
            },

            handleScale: function (event) {
                if (this.data.enabled) {
                    this.scaleFactor *= 1 + event.detail.spreadChange / event.detail.startSpread;

                    this.scaleFactor = Math.min(Math.max(this.scaleFactor, this.data.minScale), this.data.maxScale);

                    this.el.object3D.scale.x = this.scaleFactor * this.initialScale.x;
                    this.el.object3D.scale.y = this.scaleFactor * this.initialScale.y;
                    this.el.object3D.scale.z = this.scaleFactor * this.initialScale.z;
                }
            }
        });

        // Initialize
        console.log('AR GLB Viewer initialized');
        showNotification('üöÄ AR GLB Viewer ƒë√£ s·∫µn s√†ng!', 'success');
    </script>
</body>
</html>