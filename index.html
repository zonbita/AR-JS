<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>AR Follow Camera Smooth</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
      html, body {
        margin: 0;
        height: 100%;
        background: #000;
        overflow: hidden;
      }
      model-viewer {
        width: 100%;
        height: 100%;
        background: #000;
      }
      .ar-btn {
        position: absolute;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        padding: 14px 22px;
        border-radius: 16px;
        border: none;
        background: linear-gradient(135deg, #ffd700, #ff8c00);
        color: #222;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <model-viewer
      id="mv"
      src="1M.glb"
      ios-src="1M.usdz"
      ar
      ar-modes="webxr quick-look"
      ar-placement="floor"
      camera-controls
      disable-pan
      alt="AR Model"
      shadow-intensity="1"
      exposure="1.1"
    ></model-viewer>

    <button id="startAR" class="ar-btn">üï∂Ô∏è Xem AR</button>

    <script type="module">
      const mv = document.querySelector("#mv");
      const startAR = document.querySelector("#startAR");

      startAR.addEventListener("click", () => mv.activateAR());

      let follow = false;
      let frameHandle;
      const distance = 1.0; // kho·∫£ng c√°ch model tr∆∞·ªõc camera (1m)
      const smoothFactor = 0.2; // h·ªá s·ªë m∆∞·ª£t (0.1‚Äì0.3 l√† h·ª£p l√Ω)

      const tmpTargetPos = new THREE.Vector3();
      const tmpOffset = new THREE.Vector3();

      mv.addEventListener("ar-status", (event) => {
        if (event.detail.status === "session-started") {
          follow = true;
          console.log("üöÄ AR started ‚Äî object will follow camera");
          followModelToCamera();
        } else if (event.detail.status === "not-presenting") {
          follow = false;
          cancelAnimationFrame(frameHandle);
          console.log("üõë AR ended");
        }
      });

      function followModelToCamera() {
        const scene = mv.scene;
        const camera = scene?.camera;
        const model = mv.model;

        if (!camera || !model) {
          frameHandle = requestAnimationFrame(followModelToCamera);
          return;
        }

        // T√≠nh v·ªã tr√≠ target tr∆∞·ªõc m·∫∑t camera
        tmpOffset.set(0, 0, -distance);
        tmpOffset.applyQuaternion(camera.quaternion);
        tmpTargetPos.copy(camera.position).add(tmpOffset);

        // LERP v·ªã tr√≠ model ‚Üí target (l√†m m∆∞·ª£t)
        model.position.lerp(tmpTargetPos, smoothFactor);

        // LERP h∆∞·ªõng model ‚Üí h∆∞·ªõng camera
        model.quaternion.slerp(camera.quaternion, smoothFactor);

        frameHandle = requestAnimationFrame(followModelToCamera);
      }
    </script>
  </body>
</html>
